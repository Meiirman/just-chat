{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>CodePen - Daily UI #013: Direct Messaging</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
    <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans'>
    <link rel='stylesheet'
        href='https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.3/jquery.mCustomScrollbar.min.css'>
    <link rel="stylesheet" href="{% static 'css.css' %}">

</head>

<body>
    <!-- partial:index.partial.html -->
    <!--

Follow me on
Dribbble: https://dribbble.com/supahfunk
Twitter: https://twitter.com/supahfunk
Codepen: https://codepen.io/supah/

It's just a concept, a fake chat to design a new daily UI for direct messaging.
Hope you like it :)

-->

    <div class="chat">
        <div class="chat-title">
            <h1>{{room_name}}</h1>
            <h2>{{nickname}}</h2>
        </div>
        <div class="messages">
            <div class="messages-content" id="psevdo-chat"></div>
        </div>
        <form class="message-box">
            <textarea type="text" id="new_message" class="message-input" placeholder="Type message..."></textarea>
            <button type="submit" id="submitButton" class="message-submit">Send</button>
    </div>

    </div>
    <div class="bg"></div>
    <!-- partial -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script
        src='https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.3/jquery.mCustomScrollbar.concat.min.js'></script>
    <script src="{% static 'js.js' %}"></script>

    <script>

        function get_newDate() {
            let date = new Date();
            let yesr_moth_day = `${(date.getDate() > 10) ? date.getDate() : +'0' + date.getDate()}.${(date.getMonth() + 1 > 10) ? date.getMonth() + 1 : '0' + (date.getMonth() + 1)}.${date.getFullYear()}` // `${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}`
            return yesr_moth_day + ` ${(date.getHours() > 10) ? date.getHours() : '0' + date.getHours()}:${(date.getMinutes() > 10) ? date.getMinutes() : '0' + date.getMinutes()}`
        }
        var audio = new Audio('/media/default/notification.mp3'); // Укажите путь к вашему звуковому файлу
        function showNotification(nickname, room_name, message) {
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    var notification = new Notification(`Новое сообщение в чате: ${room_name}`, {
                        body: `[${get_newDate()}] ${nickname} : ${message}`,
                    });
                    notification.onclick = function () {
                        console.log('Уведомление было кликнуто');
                    };
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission().then(function (permission) {
                        if (permission === 'granted') {
                            var notification = new Notification(`Новое сообщение в чате: ${room_name}`, {
                                body: `[${get_newDate()}] ${nickname} : ${message}`,
                            });
                            notification.onclick = function () {
                                console.log('Уведомление было кликнуто');
                            };
                        }
                    });
                }
            } else {
                console.log('Уведомления Push не поддерживаются в этом браузере.');
            }
        }


        function updateData(data) {
            document.getElementById("psevdo-chat").innerHTML = `
            <p> [${get_newDate()}] ${data['nickname']} : ${data['message']} <p> <br>
            ` + document.getElementById("psevdo-chat").innerHTML
            if (data['nickname'] != '{{nickname}}')
                showNotification(data['nickname'], '{{room_name}}', data['message'])

        }
        function connect() {
            if ("WebSocket" in window) {
                let chatSocket = new WebSocket("wss://" + window.location.host + "/ws/chat/" + "room_{{ room_name }}/");
                chatSocket.onopen = function (event) {
                    console.log("Successfully connected to the WebSocket.");
                }
                chatSocket.onmessage = function (event) {
                    const data = JSON.parse(event.data);
                    console.log('Received data:', data);
                    console.log("data в функции connect", data)
                    if (data['nickname'] != '{{nickname}}') audio.play();
                    updateData(data)
                }
                chatSocket.onclose = function (event) {
                    console.log("WebSocket connection closed unexpectedly. Trying to reconnect in 2s...");
                    setTimeout(function () {
                        console.log("Reconnecting...");
                        connect()
                    }, 2000);
                }
                function sendData(new_message) {
                    if (chatSocket.readyState === WebSocket.OPEN) {
                        data = {
                            'message': new_message,
                            'nickname': '{{ nickname }}'
                        }
                        chatSocket.send(JSON.stringify(data));
                    } else {
                        console.error('WebSocket connection is not open.');
                    }
                }
            } else {
                console.error("WebSocket is not supported by your browser.");
            }
            document.getElementById("submitButton").addEventListener("click", function (event) {
                event.preventDefault(); //
                let new_message = document.getElementById("new_message").value
                if (new_message != "") sendData(new_message)
                document.getElementById("new_message").value = ""

            });
        }

        connect()

    </script>

</body>

</html>

